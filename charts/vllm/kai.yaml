apiVersion: batch/v1
kind: Job
metadata:
  name: test
  labels:
    # KAI uses labels for queue and project association
    kai.scheduler/queue: default
    kalavai.job.name: test-kai
spec:
  # The Pod-Grouper will automatically set minMember based on this
  parallelism: 1 
  completions: 1
  backoffLimit: 100 # Equivalent to maxRetry
  template:
    metadata:
      labels:
        # Essential: KAI tracks workloads via this label
        kai.scheduler/queue: default
        kalavai.job.name: test-kai
      annotations:
        # If using fractional GPUs on NVIDIA:
        # gpu-fraction: "0.5" 
    spec:
      schedulerName: kai-scheduler
      priorityClassName: 
      terminationGracePeriodSeconds: 60
      
      runtimeClassName: nvidia
      

      # Node Affinity (Remains the same as standard K8s)

      containers:
      - name: vllm-node
        image: ghcr.io/kalavai-net/vllm-cuda:v0.13.0
        command:
        - sh
        - -c
        - |
          # SERVICE DISCOVERY CHANGE: 
          # Instead of /etc/volcano/server.host, use the service name you create
          LEADER_HOST="test-leader-svc"; 
          
          
          nvidia-smi;
          

          # Logic to determine if I am leader or worker based on index
          # (K8s Jobs provide the index via environment variable)
          if [ "$JOB_COMPLETION_INDEX" = "0" ]; then
            /home/ray/workspace/ray_init.sh leader --ray_cluster_size=1 ...
          else
            /home/ray/workspace/ray_init.sh worker --ray_address=$LEADER_HOST ...
          fi
        resources:
          limits:
            cpu: 2
            memory: 14Gi
            nvidia.com/gpu: 1
          requests:
            cpu: 2
            memory: 14Gi
            nvidia.com/gpu: 1
        volumeMounts:
          - mountPath: /dev/shm
            name: dshm
          - name: cache
            mountPath: /home/ray/cache
      volumes:
      - name: cache
        emptyDir: {}
      - name: dshm
        emptyDir:
          medium: Memory
          sizeLimit: 7Gi
      restartPolicy: OnFailure